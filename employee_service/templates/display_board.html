{% extends "base.html" %}

{% block title %}Order Display Board{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="card shadow-lg border-0 mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="mb-0"><i class="bi bi-grid-3x3-gap"></i> Order Display Board</h1>
                <div>
                    <span id="lastUpdate" class="text-muted me-3">
                        <i class="bi bi-clock"></i> Last update: <span id="updateTime">--:--</span>
                    </span>
                    <span class="badge bg-success me-2">
                        <i class="bi bi-arrow-clockwise"></i> Auto-refresh: 5s
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card border-danger shadow">
                <div class="card-body text-center">
                    <i class="bi bi-circle-fill text-danger fs-3"></i>
                    <h5 class="mt-2">New Order</h5>
                    <p class="text-muted small mb-0">Just received - needs attention</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-warning shadow">
                <div class="card-body text-center">
                    <i class="bi bi-circle-fill text-warning fs-3"></i>
                    <h5 class="mt-2">Cooking</h5>
                    <p class="text-muted small mb-0">In progress - being prepared</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-success shadow">
                <div class="card-body text-center">
                    <i class="bi bi-circle-fill text-success fs-3"></i>
                    <h5 class="mt-2">Ready</h5>
                    <p class="text-muted small mb-0">Complete - auto-clears in 5 min</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Orders Grid -->
    <div class="row g-4" id="ordersGrid">
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading orders...</p>
        </div>
    </div>
</div>

<style>
    body {
        background: #1a1a2e !important;
    }

    .order-card-new {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        border: 3px solid #dc3545;
        animation: pulse-red 2s infinite;
    }

    .order-card-cooking {
        background: linear-gradient(135deg, #ffd93d 0%, #f6b93b 100%);
        border: 3px solid #ffc107;
        animation: pulse-yellow 2s infinite;
    }

    .order-card-ready {
        background: linear-gradient(135deg, #6bcf7f 0%, #51cf66 100%);
        border: 3px solid #28a745;
        animation: pulse-green 2s infinite;
    }

    @keyframes pulse-red {
        0%, 100% { box-shadow: 0 0 20px rgba(220, 53, 69, 0.5); }
        50% { box-shadow: 0 0 40px rgba(220, 53, 69, 0.8); }
    }

    @keyframes pulse-yellow {
        0%, 100% { box-shadow: 0 0 20px rgba(255, 193, 7, 0.5); }
        50% { box-shadow: 0 0 40px rgba(255, 193, 7, 0.8); }
    }

    @keyframes pulse-green {
        0%, 100% { box-shadow: 0 0 20px rgba(40, 167, 69, 0.5); }
        50% { box-shadow: 0 0 40px rgba(40, 167, 69, 0.8); }
    }

    .order-card {
        border-radius: 20px;
        transition: all 0.3s ease;
        color: white;
        min-height: 250px;
    }

    .order-card:hover {
        transform: scale(1.05);
    }

    .order-number {
        font-size: 2.5rem;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .order-time {
        font-size: 1.2rem;
        opacity: 0.9;
    }

    .order-items {
        background: rgba(255, 255, 255, 0.2);
        padding: 10px;
        border-radius: 10px;
        backdrop-filter: blur(10px);
    }

    .timer {
        font-size: 1.5rem;
        font-weight: bold;
        font-family: 'Courier New', monospace;
    }

    .legend-card {
        transition: all 0.3s ease;
    }

    .legend-card:hover {
        transform: translateY(-5px);
    }
</style>

<script>
let orders = [];
let completedOrders = new Map(); // Track when orders were completed

function updateTime() {
    const now = new Date();
    document.getElementById('updateTime').textContent = now.toLocaleTimeString();
}

function calculateTimeSince(orderTime) {
    const now = new Date();
    const order = new Date(orderTime);
    const diffMs = now - order;
    const diffMins = Math.floor(diffMs / 60000);
    const diffSecs = Math.floor((diffMs % 60000) / 1000);
    
    if (diffMins > 0) {
        return `${diffMins}m ${diffSecs}s`;
    }
    return `${diffSecs}s`;
}

function getOrderStatus(order) {
    if (order.status === 'completed') return 'ready';
    if (order.status === 'in_progress') return 'cooking';
    return 'new';
}

async function loadOrders() {
    try {
        const response = await fetch('/api/orders');
        const data = await response.json();
        
        // Track completed orders with timestamps
        data.forEach(order => {
            if (order.status === 'completed') {
                if (!completedOrders.has(order.id)) {
                    completedOrders.set(order.id, Date.now());
                }
            } else {
                completedOrders.delete(order.id);
            }
        });

        // Remove completed orders that are older than 5 minutes
        const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
        const filteredOrders = data.filter(order => {
            if (order.status === 'completed') {
                const completedTime = completedOrders.get(order.id);
                if (completedTime && completedTime < fiveMinutesAgo) {
                    completedOrders.delete(order.id);
                    return false;
                }
            }
            return true;
        });

        orders = filteredOrders;
        renderOrders();
        updateTime();
    } catch (error) {
        console.error('Error loading orders:', error);
    }
}

function renderOrders() {
    const grid = document.getElementById('ordersGrid');
    
    if (orders.length === 0) {
        grid.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="bi bi-inbox text-white-50" style="font-size: 5rem;"></i>
                <h3 class="text-white mt-3">No Active Orders</h3>
                <p class="text-white-50">New orders will appear here automatically</p>
            </div>
        `;
        return;
    }

    // Sort orders: pending first, then in_progress, then completed
    const sortedOrders = [...orders].sort((a, b) => {
        const statusOrder = { 'pending': 0, 'in_progress': 1, 'completed': 2 };
        return statusOrder[a.status] - statusOrder[b.status];
    });

    grid.innerHTML = sortedOrders.map(order => {
        const status = getOrderStatus(order);
        const statusText = {
            'new': 'NEW ORDER',
            'cooking': 'COOKING',
            'ready': 'READY'
        }[status];

        const timeSince = order.order_time ? calculateTimeSince(order.order_time) : 'N/A';
        
        return `
            <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="card order-card order-card-${status} shadow-lg">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <span class="badge bg-dark bg-opacity-50 px-4 py-2">
                                ${statusText}
                            </span>
                        </div>
                        <div class="order-number mb-3">
                            #${order.order_number}
                        </div>
                        <h5 class="mb-3">
                            <i class="bi bi-person-circle"></i> ${order.customer_name}
                        </h5>
                        <div class="order-items mb-3">
                            <small>${order.order_items}</small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="timer">
                                <i class="bi bi-clock"></i> ${timeSince}
                            </div>
                            <div class="fs-4 fw-bold">
                                $${parseFloat(order.total_price).toFixed(2)}
                            </div>
                        </div>
                        ${order.customer_phone ? `
                            <div class="mt-2">
                                <small><i class="bi bi-telephone"></i> ${order.customer_phone}</small>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Initial load
loadOrders();

// Auto-refresh every 5 seconds
setInterval(loadOrders, 5000);

// Update timers every second
setInterval(() => {
    if (orders.length > 0) {
        renderOrders();
    }
}, 1000);
</script>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
{% endblock %}
